{% extends "base.html" %}

{% block title %}Reports - MutaSight AI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-file-alt me-2"></i>Reports</h2>
                    <p class="text-muted">Generate and manage scientific reports for your drug discovery projects.</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newReportModal">
                    <i class="fas fa-plus me-2"></i>Generate Report
                </button>
            </div>
        </div>
    </div>
    
    <!-- Report Types -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Report Templates</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="report-template-card text-center p-3 border rounded">
                                <i class="fas fa-atom fa-3x text-primary mb-3"></i>
                                <h6>Molecular Analysis</h6>
                                <p class="text-muted small">Comprehensive molecular structure analysis with properties and drug-likeness assessment.</p>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="generateReportType('molecular_analysis')">
                                    Generate
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="report-template-card text-center p-3 border rounded">
                                <i class="fas fa-pills fa-3x text-success mb-3"></i>
                                <h6>Formulation Report</h6>
                                <p class="text-muted small">Drug formulation recommendations with excipient selection and manufacturing guidance.</p>
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="generateReportType('formulation')">
                                    Generate
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="report-template-card text-center p-3 border rounded">
                                <i class="fas fa-project-diagram fa-3x text-info mb-3"></i>
                                <h6>Project Summary</h6>
                                <p class="text-muted small">Complete project overview with team activities, analyses, and milestones achieved.</p>
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="generateReportType('project_summary')">
                                    Generate
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="report-template-card text-center p-3 border rounded">
                                <i class="fas fa-balance-scale fa-3x text-warning mb-3"></i>
                                <h6>Regulatory Summary</h6>
                                <p class="text-muted small">Regulatory compliance summary with safety data and approval pathway guidance.</p>
                                <button class="btn btn-sm btn-outline-warning" 
                                        onclick="generateReportType('regulatory')">
                                    Generate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Generated Reports -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Generated Reports</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary active" id="allReports">
                            All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="myReports">
                            My Reports
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="sharedReports">
                            Shared
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if reports %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Report Title</th>
                                        <th>Type</th>
                                        <th>Generated</th>
                                        <th>Project</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for report in reports %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="report-icon me-3">
                                                    {% if report.report_type == 'molecular_analysis' %}
                                                        <i class="fas fa-atom text-primary"></i>
                                                    {% elif report.report_type == 'formulation' %}
                                                        <i class="fas fa-pills text-success"></i>
                                                    {% elif report.report_type == 'project_summary' %}
                                                        <i class="fas fa-project-diagram text-info"></i>
                                                    {% else %}
                                                        <i class="fas fa-file-alt text-secondary"></i>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <strong>{{ report.title }}</strong>
                                                    {% if report.content %}
                                                        <br><small class="text-muted">{{ report.content[:50] }}...</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'primary' if report.report_type == 'molecular_analysis' else 'success' if report.report_type == 'formulation' else 'info' if report.report_type == 'project_summary' else 'secondary' }}">
                                                {{ report.report_type.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td>{{ report.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if report.project_id %}
                                                <a href="{{ url_for('main.project_detail', project_id=report.project_id) }}" 
                                                   class="text-decoration-none">
                                                    Project #{{ report.project_id }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Ready
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('main.download_report', report_id=report.id) }}" 
                                                   class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                <button class="btn btn-sm btn-outline-secondary" 
                                                        onclick="previewReport({{ report.id }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" 
                                                        onclick="shareReport({{ report.id }})">
                                                    <i class="fas fa-share"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteReport({{ report.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-file-alt fa-4x mb-4"></i>
                            <h4>No Reports Generated</h4>
                            <p class="mb-4">Start by generating your first report using one of the templates above.</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newReportModal">
                                <i class="fas fa-plus me-2"></i>Generate Your First Report
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Report Modal -->
<div class="modal fade" id="newReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate New Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newReportForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="reportTitle" class="form-label">Report Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="reportTitle" required 
                                   placeholder="Enter report title...">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="reportType" class="form-label">Report Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="reportType" required>
                                <option value="">Select report type...</option>
                                <option value="molecular_analysis">Molecular Analysis</option>
                                <option value="formulation">Formulation Report</option>
                                <option value="project_summary">Project Summary</option>
                                <option value="regulatory">Regulatory Summary</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="projectSelect" class="form-label">Associated Project (Optional)</label>
                        <select class="form-select" id="projectSelect">
                            <option value="">Select a project...</option>
                            <!-- Projects will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reportDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="reportDescription" rows="3" 
                                  placeholder="Describe the contents and purpose of this report..."></textarea>
                    </div>
                    
                    <div id="reportSpecificOptions">
                        <!-- Report-specific options will be loaded here based on selected type -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateCustomReport()">
                    <i class="fas fa-file-pdf me-1"></i>Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Report Preview Modal -->
<div class="modal fade" id="reportPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reportPreviewContent">
                <!-- Report preview will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadCurrentReport()">
                    <i class="fas fa-download me-1"></i>Download PDF
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentReportId = null;

// Report type change handler
document.getElementById('reportType').addEventListener('change', function() {
    const reportType = this.value;
    const optionsContainer = document.getElementById('reportSpecificOptions');
    
    if (reportType === 'molecular_analysis') {
        optionsContainer.innerHTML = `
            <div class="mb-3">
                <label for="smilesInput" class="form-label">SMILES Notation</label>
                <input type="text" class="form-control" id="smilesInput" 
                       placeholder="Enter SMILES for molecular analysis...">
            </div>
        `;
    } else if (reportType === 'formulation') {
        optionsContainer.innerHTML = `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="activeIngredient" class="form-label">Active Ingredient</label>
                    <input type="text" class="form-control" id="activeIngredient" 
                           placeholder="Enter active ingredient name...">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="dosageForm" class="form-label">Dosage Form</label>
                    <select class="form-select" id="dosageForm">
                        <option value="">Select dosage form...</option>
                        <option value="tablet">Tablet</option>
                        <option value="capsule">Capsule</option>
                        <option value="injection">Injection</option>
                        <option value="suspension">Suspension</option>
                    </select>
                </div>
            </div>
        `;
    } else {
        optionsContainer.innerHTML = '';
    }
});

function generateReportType(reportType) {
    document.getElementById('reportType').value = reportType;
    document.getElementById('reportType').dispatchEvent(new Event('change'));
    
    // Set default title based on type
    const titles = {
        'molecular_analysis': 'Molecular Analysis Report',
        'formulation': 'Drug Formulation Report',
        'project_summary': 'Project Summary Report',
        'regulatory': 'Regulatory Summary Report'
    };
    
    document.getElementById('reportTitle').value = titles[reportType] || 'Report';
    
    const modal = new bootstrap.Modal(document.getElementById('newReportModal'));
    modal.show();
}

function generateCustomReport() {
    const title = document.getElementById('reportTitle').value;
    const reportType = document.getElementById('reportType').value;
    const projectId = document.getElementById('projectSelect').value;
    const description = document.getElementById('reportDescription').value;
    
    if (!title || !reportType) {
        alert('Please fill in required fields');
        return;
    }
    
    // Collect report-specific data
    const content = {
        description: description
    };
    
    if (reportType === 'molecular_analysis') {
        const smiles = document.getElementById('smilesInput')?.value;
        if (smiles) {
            content.molecular_data = { smiles: smiles };
        }
    } else if (reportType === 'formulation') {
        const activeIngredient = document.getElementById('activeIngredient')?.value;
        const dosageForm = document.getElementById('dosageForm')?.value;
        if (activeIngredient) {
            content.active_ingredient = { name: activeIngredient };
        }
        if (dosageForm) {
            content.dosage_form = dosageForm;
        }
    }
    
    // Generate report
    fetch('/generate-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            report_type: reportType,
            title: title,
            content: content,
            project_id: projectId || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and show success
            bootstrap.Modal.getInstance(document.getElementById('newReportModal')).hide();
            alert('Report generated successfully!');
            location.reload(); // Refresh to show new report
        } else {
            alert('Error generating report: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while generating the report');
    });
}

function previewReport(reportId) {
    currentReportId = reportId;
    const modal = new bootstrap.Modal(document.getElementById('reportPreviewModal'));
    document.getElementById('reportPreviewContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading report preview...</p>
        </div>
    `;
    modal.show();
    
    // Simulate loading report preview
    setTimeout(() => {
        document.getElementById('reportPreviewContent').innerHTML = `
            <div class="report-preview">
                <div class="text-center mb-4">
                    <h3>Report Preview</h3>
                    <p class="text-muted">This is a preview of the generated report.</p>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Full report content would be displayed here. In a real implementation, 
                    this would show the actual report content formatted for web viewing.
                </div>
            </div>
        `;
    }, 1000);
}

function shareReport(reportId) {
    // Implement report sharing functionality
    alert('Report sharing functionality would be implemented here');
}

function deleteReport(reportId) {
    if (confirm('Are you sure you want to delete this report?')) {
        // Implement report deletion
        alert('Report deletion functionality would be implemented here');
    }
}

function downloadCurrentReport() {
    if (currentReportId) {
        window.open(`/download-report/${currentReportId}`, '_blank');
    }
}

// Tab functionality
document.getElementById('allReports').addEventListener('click', function() {
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    this.classList.add('active');
    // Filter reports logic would go here
});

document.getElementById('myReports').addEventListener('click', function() {
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    this.classList.add('active');
    // Filter reports logic would go here
});

document.getElementById('sharedReports').addEventListener('click', function() {
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    this.classList.add('active');
    // Filter reports logic would go here
});
</script>
{% endblock %}
