{% extends "base.html" %}

{% block title %}Molecular Input - MutaSight{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-gradient mb-1">
                <i data-feather="layers" class="me-2"></i>Molecular Structure Input
            </h2>
            <p class="text-muted mb-4">Enter molecular structures in any format - we'll auto-detect and analyze them</p>
        </div>
    </div>

    <div class="row">
        <!-- Input Form -->
        <div class="col-lg-8">
            <div class="card shadow-custom">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i data-feather="edit-3" class="me-2"></i>Input Molecular Structure
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate>
                        <!-- Project Selection -->
                        <div class="mb-3">
                            <label for="project_id" class="form-label">
                                <i data-feather="folder" class="me-2"></i>Project (Optional)
                            </label>
                            <select class="form-select" id="project_id" name="project_id">
                                <option value="">Create new project or select existing</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}">{{ project.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Molecular Input -->
                        <div class="mb-3">
                            <label for="molecular_input" class="form-label">
                                <i data-feather="code" class="me-2"></i>Molecular Structure
                            </label>
                            <div class="position-relative">
                                <textarea 
                                    class="form-control molecular-input" 
                                    id="molecular_input" 
                                    name="molecular_input" 
                                    rows="8" 
                                    placeholder="Enter molecular structure:&#10;• SMILES: c1ccccc1&#10;• InChI: InChI=1S/C6H6/c1-2-4-6-5-3-1/h1-6H&#10;• PDB format: HEADER, ATOM, HETATM records&#10;• Peptide sequence: ACDEFGHIKLMNPQRSTVWY"
                                    required
                                ></textarea>
                                <div class="invalid-feedback">
                                    Please provide a molecular structure.
                                </div>
                            </div>
                        </div>

                        <!-- Input Format Detection -->
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-secondary">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">
                                                <i data-feather="eye" class="me-2"></i>Auto-Detection
                                            </h6>
                                            <p class="mb-2 text-muted">Detected Format:</p>
                                            <span class="badge bg-primary" id="detected-format">None</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-secondary">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">
                                                <i data-feather="check-circle" class="me-2"></i>Validation
                                            </h6>
                                            <p class="mb-2 text-muted">Input Status:</p>
                                            <span class="badge bg-secondary" id="validation-status">Ready</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Examples -->
                        <div class="mb-4">
                            <h6 class="mb-3">
                                <i data-feather="bookmark" class="me-2"></i>Quick Examples
                            </h6>
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 example-btn" 
                                            data-example="c1ccccc1" data-name="Benzene">
                                        Benzene (SMILES)
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 example-btn" 
                                            data-example="CC(=O)Nc1ccc(O)cc1" data-name="Acetaminophen">
                                        Acetaminophen
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 example-btn" 
                                            data-example="ACDEFGHIKLMNPQRSTVWY" data-name="Sample Peptide">
                                        Sample Peptide
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 example-btn" 
                                            data-example="InChI=1S/C6H6/c1-2-4-6-5-3-1/h1-6H" data-name="Benzene InChI">
                                        Benzene (InChI)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-outline-secondary me-md-2" onclick="clearInput()">
                                <i data-feather="x" class="me-2"></i>Clear
                            </button>
                            <button type="submit" class="btn btn-gradient btn-loading">
                                <i data-feather="play" class="me-2"></i>Analyze Structure
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- File Upload -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i data-feather="upload" class="me-2"></i>Upload File
                    </h6>
                </div>
                <div class="card-body">
                    <div class="upload-area p-4 text-center border border-dashed rounded">
                        <i data-feather="file-text" class="text-muted mb-3" style="width: 48px; height: 48px;"></i>
                        <p class="text-muted mb-3">Drop PDB, SDF, or text files here</p>
                        <input type="file" id="file-upload" class="d-none" accept=".pdb,.sdf,.txt,.mol">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('file-upload').click()">
                            <i data-feather="upload" class="me-2"></i>Choose File
                        </button>
                    </div>
                </div>
            </div>

            <!-- Input Help -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i data-feather="help-circle" class="me-2"></i>Supported Formats
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex align-items-center">
                            <span class="badge bg-primary me-3">SMILES</span>
                            <small class="text-muted">Simplified molecular-input line-entry system</small>
                        </div>
                        <div class="list-group-item d-flex align-items-center">
                            <span class="badge bg-success me-3">InChI</span>
                            <small class="text-muted">International Chemical Identifier</small>
                        </div>
                        <div class="list-group-item d-flex align-items-center">
                            <span class="badge bg-info me-3">PDB</span>
                            <small class="text-muted">Protein Data Bank format</small>
                        </div>
                        <div class="list-group-item d-flex align-items-center">
                            <span class="badge bg-warning me-3">Peptide</span>
                            <small class="text-muted">Amino acid sequences</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Preview -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i data-feather="eye" class="me-2"></i>Live Preview
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="molecular-viewer" id="preview-viewer" style="height: 300px;">
                        <div class="viewer-controls">
                            <button class="btn btn-sm btn-secondary reset-view" title="Reset View">
                                <i data-feather="rotate-ccw"></i>
                            </button>
                            <select class="btn btn-sm btn-secondary render-mode">
                                <option value="ballandstick">Ball & Stick</option>
                                <option value="spacefill">Space Fill</option>
                                <option value="wireframe">Wireframe</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            Enter a structure to see preview
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let previewViewer = null;

document.addEventListener('DOMContentLoaded', function() {
    const molecularInput = document.getElementById('molecular_input');
    const detectedFormat = document.getElementById('detected-format');
    const validationStatus = document.getElementById('validation-status');
    const fileUpload = document.getElementById('file-upload');
    
    // Initialize preview viewer
    previewViewer = initializeMolecularViewer('preview-viewer');
    
    // Input detection and validation
    molecularInput.addEventListener('input', debounce(function() {
        const input = this.value.trim();
        
        if (!input) {
            detectedFormat.textContent = 'None';
            detectedFormat.className = 'badge bg-secondary';
            validationStatus.textContent = 'Ready';
            validationStatus.className = 'badge bg-secondary';
            return;
        }
        
        // Detect input type
        const format = detectInputType(input);
        detectedFormat.textContent = format.toUpperCase();
        detectedFormat.className = `badge bg-${getFormatColor(format)}`;
        
        // Validate input
        const isValid = validateInput(input, format);
        validationStatus.textContent = isValid ? 'Valid' : 'Invalid';
        validationStatus.className = `badge bg-${isValid ? 'success' : 'danger'}`;
        
        // Update preview
        if (isValid && format === 'smiles') {
            previewViewer.loadMolecule(input);
        }
    }, 500));
    
    // Example buttons
    document.querySelectorAll('.example-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const example = this.dataset.example;
            molecularInput.value = example;
            molecularInput.dispatchEvent(new Event('input'));
            molecularInput.focus();
        });
    });
    
    // File upload
    fileUpload.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            MutaSight.handleFileUpload(this, function(content, filename) {
                molecularInput.value = content;
                molecularInput.dispatchEvent(new Event('input'));
                MutaSight.showNotification(`File "${filename}" loaded successfully`, 'success');
            });
        }
    });
    
    // Form submission
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (form.checkValidity()) {
            MutaSight.showButtonLoading(submitBtn);
        }
    });
    
    // Auto-focus input
    molecularInput.focus();
});

function detectInputType(input) {
    input = input.trim().toUpperCase();
    
    if (input.startsWith('INCHI=')) {
        return 'inchi';
    }
    
    if (input.startsWith('HEADER') || input.startsWith('ATOM') || input.startsWith('HETATM')) {
        return 'pdb';
    }
    
    if (/^[ACDEFGHIKLMNPQRSTVWY]+$/.test(input) && input.length > 2) {
        return 'peptide';
    }
    
    if (/^[A-Za-z0-9@+\-\[\]()=#$:%\\\/\.]+$/.test(input)) {
        return 'smiles';
    }
    
    return 'unknown';
}

function validateInput(input, format) {
    switch (format) {
        case 'smiles':
            return validateSMILES(input);
        case 'inchi':
            return input.startsWith('InChI=');
        case 'pdb':
            return input.includes('ATOM') || input.includes('HETATM');
        case 'peptide':
            return /^[ACDEFGHIKLMNPQRSTVWY]+$/.test(input.toUpperCase());
        default:
            return false;
    }
}

function validateSMILES(smiles) {
    // Basic SMILES validation
    const brackets = { '(': ')', '[': ']' };
    const stack = [];
    
    for (let char of smiles) {
        if (char in brackets) {
            stack.push(char);
        } else if (Object.values(brackets).includes(char)) {
            if (!stack.length) return false;
            const last = stack.pop();
            if (brackets[last] !== char) return false;
        }
    }
    
    return stack.length === 0;
}

function getFormatColor(format) {
    const colors = {
        'smiles': 'primary',
        'inchi': 'success',
        'pdb': 'info',
        'peptide': 'warning',
        'unknown': 'danger'
    };
    return colors[format] || 'secondary';
}

function clearInput() {
    document.getElementById('molecular_input').value = '';
    document.getElementById('molecular_input').dispatchEvent(new Event('input'));
    document.getElementById('molecular_input').focus();
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
</script>
{% endblock %}
